# Install TKG Management Cluster

Follow the [official docs](https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/index.html) for background and pre-requisite tasks.

First complete `Set Up the Bootstrap Environment for Tanzu Kubernetes Grid` which gets your tkg cli, kubectl and docker setup.

Then Follow the next section that applies for your environment: AWS or vSphere. These instructions are based on the official docs steps that use the CLI. Alternatively you can use the Installer Interface and have the config file autogenerated with correct & well formatted values.

## Install TKG Management Cluster on AWS

1. Complete `Prepare to Deploy the Management Cluster to Amazon EC2` which does setup activity in EC2. You can use the following script which hard codes us-east-2 (but you can change this) and stores the private key at keys/aws-ssh.pem

```bash
#make sure you have AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, and AWS_REGION vars set
./scripts/01-prep-aws-objects.sh
```

2. Complete `Deploy the Management Cluster to Amazon EC2 with the CLI`. You can use a config-REDACTED.yaml locate at the root of this repo.  You can use that as a reference of what a given config.yaml ended up looking like after the tasks described in the docs.  Also, you can use this script to complete the deployment.

```bash
#make sure you have AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY vars set
./02-deploy-aws-mgmt-cluster.sh

# Once completed scale the worker nodes for the management cluster
tkg scale cluster tkg-mgmt-aws --namespace tkg-system -w 2
```

3. Install Default Storage Class. Run the following command to apply a default storage class that uses the AWS EBS provisioner to the cluster.

```bash
kubectl apply -f clusters/mgmt/default-storage-class-aws.yaml
```

4. Validation Step. Check management cluster is provisioned, pods are running and sc is configured;

```bash
tkg get management-clusters
kubectl get pods -A
kubectl get sc
```

## Install TKG Management Cluster on vSphere

1. Complete `Prepare to Deploy the Management Cluster to vSphere` which prepares an SSH key and the OS image templates to be used for all clusters.

First thing you need to do is to download the OVAs from https://www.vmware.com/go/get-tkg. You need to get:
- VMware Tanzu Kubernetes Grid 1.0.0 Kubernetes v1.17.3 OVA (Photon OS)
- VMware Tanzu Kubernetes Grid 1.0.0 Load Balancer OVA

Then you can follow the manual steps in the documentation or use this script to automate the creation of the SSH key, upload OVAs and set as template. SSH keys will be stored at keys/tkg_rsa and tkg/tkg_rsa.pub

You'll need to install [govc](https://github.com/vmware/govmomi/tree/master/govc#installation). Then run the script replacing the parameters with the values in your vsphere environment and local folders:

```bash
./scripts/01-prep-vsphere-objects.sh URL USERNAME PASSWORD DATASTORE TEMPLATE_FOLDER OVA_FOLDER
```

2. Complete `Deploy the Management Cluster to vSphere with the CLI`. You can use a config-REDACTED.yaml locate at the root of this repo.  You can use that as a reference of what a given config.yaml ended up looking like after the tasks described in the docs.  Also, you can use this script to complete the deployment.

```bash
./02-deploy-vsphere-mgmt-cluster.sh

# Once completed scale the worker nodes for the management cluster
tkg scale cluster tkg-mgmt-vsphere --namespace tkg-system -w 2
```

3. Configure CSI Storage Policy and Install Default Storage Class.

Follow these steps in vCenter:
- Tags & Custom Attributes -> Categories -> New -> k8s-storage (Datastore, Datastore Cluster)
- Tags & Custom Attributes -> Tags -> New -> k8s-storage (choose k8s-storage category)
- Policies & Profiles > VM Storage Profiles > Create VM Storage Policy
  - Name: “k8s Storage Policy”
  - Enable tag placement
  - Choose category and tag created previously
  - Confirm your storage Datastore is compatible

Then run the following command to apply a default storage class that uses the CNS provisioner to the cluster.

```bash
kubectl apply -f clusters/mgmt/default-storage-class-vsphere.yaml
```

4. Validation Step. Check management cluster is provisioned, pods are running and sc is configured;

```bash
tkg get management-clusters
kubectl get pods -A
kubectl get sc
```
