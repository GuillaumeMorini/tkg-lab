# Get, update, and deploy Acme-fitness app

## Set environment variables

The scripts to prepare the YAML to deploy acme-fitness depend on a few environmental variables to be set.  Set the following variables in you terminal session:

```bash
# the DNS CN to be used for acme-fitness frontend
export ACME_FITNESS_CN=acme-fitness.wlc-1.tkg-aws-lab.winterfell.live
```

## Prepare Manifests

Prepare the YAML manifests for the related acme-fitness K8S objects.  Manifest will be output into `clusters/wlc-1/acme-fitness/generated/` in case you want to inspect.

```bash
./scripts/generate-acme-fitness-yaml.sh
```

## Deploy acme-fitness

```bash
git clone https://github.com/vmwarecloudadvocacy/acme_fitness_demo.git
cd acme_fitness_demo
git checkout 158bbe2
cd ..
rm -rf acme_fitness_demo/.git
rm -rf acme_fitness_demo/aws-fargate
rm -rf acme_fitness_demo/docker-compose
```

```bash
kubectl apply -f clusters/wlc-1/acme-fitness/acme-fitness-mongodata-pvc.yaml
kubectl create secret generic cart-redis-pass --from-literal=password=KeepItSimple1! --namespace acme-fitness
kubectl label secret cart-redis-pass app=acmefit
kubectl apply -f acme_fitness_demo/kubernetes-manifests/cart-redis-total.yaml --namespace acme-fitness
kubectl apply -f acme_fitness_demo/kubernetes-manifests/cart-total.yaml --namespace acme-fitness
kubectl create secret generic catalog-mongo-pass  --from-literal=password=KeepItSimple1! --namespace acme-fitness
kubectl label secret catalog-mongo-pass app=acmefit
kubectl create -f acme_fitness_demo/kubernetes-manifests/catalog-db-initdb-configmap.yaml --namespace acme-fitness
kubectl label cm catalog-initdb-config app=acmefit
kubectl apply -f acme_fitness_demo/kubernetes-manifests/catalog-db-total.yaml --namespace acme-fitness
kubectl apply -f acme_fitness_demo/kubernetes-manifests/catalog-total.yaml --namespace acme-fitness
kubectl apply -f acme_fitness_demo/kubernetes-manifests/payment-total.yaml --namespace acme-fitness
kubectl create secret generic order-postgres-pass --from-literal=password=KeepItSimple1! --namespace acme-fitness
kubectl label secret order-postgres-pass app=acmefit
kubectl apply -f acme_fitness_demo/kubernetes-manifests/order-db-total.yaml --namespace acme-fitness
kubectl apply -f acme_fitness_demo/kubernetes-manifests/order-total.yaml --namespace acme-fitness
kubectl create secret generic users-mongo-pass --from-literal=password=KeepItSimple1! --namespace acme-fitness
kubectl label secret users-mongo-pass app=acmefit
kubectl create secret generic users-redis-pass --from-literal=password=KeepItSimple1! --namespace acme-fitness
kubectl label secret users-redis-pass app=acmefit
kubectl create -f acme_fitness_demo/kubernetes-manifests/users-db-initdb-configmap.yaml --namespace acme-fitness
kubectl label cm users-initdb-config app=acmefit
kubectl apply -f acme_fitness_demo/kubernetes-manifests/users-db-total.yaml --namespace acme-fitness
kubectl apply -f acme_fitness_demo/kubernetes-manifests/users-redis-total.yaml --namespace acme-fitness
kubectl apply -f acme_fitness_demo/kubernetes-manifests/users-total.yaml --namespace acme-fitness
kubectl patch deployment catalog-mongo  --type merge -p "$(cat clusters/wlc-1/acme-fitness/catalog-db-patch-volumes.yaml)"
kubectl apply -f acme_fitness_demo/kubernetes-manifests/frontend-total.yaml --namespace acme-fitness
kubectl apply -f clusters/wlc-1/acme-fitness/acme-fitness-frontend-ingress.yaml
# Wait for acme-fitness-tls to be generated by cert-manager
watch kubectl get secret acme-fitness-tls -n acme-fitness
kubectl label secret acme-fitness-tls app=acmefit -n acme-fitness
```

### Validation Step

Go to the ingress URL to test out.  Mine is https://acme-fitness.wlc-1.tkg-aws-lab.winterfell.live
